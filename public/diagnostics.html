<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beast Tactics - Diagnostics</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #222;
      color: #eee;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #4CAF50;
      margin-bottom: 20px;
    }
    .diagnostic-section {
      background: #333;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #3e8e41;
    }
    .results {
      padding: 10px;
      background: #2a2a2a;
      border-radius: 3px;
      font-family: monospace;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    .success {
      color: #4CAF50;
    }
    .warning {
      color: #FFA500;
    }
    .error {
      color: #F44336;
    }
    .log-entry {
      margin-bottom: 5px;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>Beast Tactics - System Diagnostics</h1>

  <div class="diagnostic-section">
    <h2>System Check</h2>
    <button id="runSystemCheck">Run System Check</button>
    <div id="systemCheckResults" class="results"></div>
  </div>

  <div class="diagnostic-section">
    <h2>State Registry</h2>
    <button id="checkStateRegistry">Check State Registry</button>
    <div id="stateRegistryResults" class="results"></div>
  </div>

  <div class="diagnostic-section">
    <h2>Texture Loading</h2>
    <button id="checkTextureLoading">Check Texture Loading</button>
    <div id="textureResults" class="results"></div>
  </div>

  <div class="diagnostic-section">
    <h2>Biome Distribution</h2>
    <button id="analyzeBiomeDistribution">Analyze Distribution</button>
    <div id="biomeResults" class="results"></div>
  </div>

  <script type="module">
    import { testTextureLoading } from '/tools/diagnostics/TextureLoader.js';
    import { analyzeMapGeneration } from '/tools/diagnostics/BiomeDistributionTest.js';
    import { runSystemCheck } from '/tools/diagnostics/SystemCheck.js';
    import { analyzeStateManager } from '/tools/diagnostics/StateRegistryCheck.js';

    // Helper to instantiate the game manager for diagnostics
    async function getTestGameManager() {
      try {
        // Dynamically import GameManager
        const { GameManager } = await import('/public/js/core/GameManager.js');

        // Create a fresh instance with testing flags
        const gameManager = new GameManager({
          version: '1.0.0',
          debugMode: true,
          testing: true
        });

        // Initialize the manager
        await gameManager.initialize();

        return gameManager;
      } catch (error) {
        console.error('Failed to create test game manager:', error);
        throw error;
      }
    }

    // System Check
    document.getElementById('runSystemCheck').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('systemCheckResults');
      resultsDiv.innerHTML = 'Running system check...';

      try {
        const results = await runSystemCheck();
        displayResults(resultsDiv, results);
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('System check error:', error);
      }
    });

    // State Registry Check
    document.getElementById('checkStateRegistry').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('stateRegistryResults');
      resultsDiv.innerHTML = 'Checking state registry...';

      try {
        const gameManager = await getTestGameManager();
        const stateManager = gameManager.stateManager;
        const results = analyzeStateManager(stateManager);

        // Format results
        let html = `<div class="${results.success ? 'success' : 'error'}">
          Status: ${results.success ? 'All states registered' : 'Issues detected'}
        </div>`;

        html += `<div class="log-entry">
          <strong>Registered States:</strong> ${results.validStateCount}/${results.totalStateCount}
        </div>`;

        if (results.missingStates.length > 0) {
          html += `<div class="log-entry error">
            <strong>Missing States:</strong> ${results.missingStates.join(', ')}
          </div>`;
        }

        if (results.transitionProblems.length > 0) {
          html += `<div class="log-entry error">
            <strong>Transition Problems:</strong>
          </div>`;

          results.transitionProblems.forEach(problem => {
            html += `<div class="log-entry error">- ${problem}</div>`;
          });
        }

        if (results.unreachableStates.length > 0) {
          html += `<div class="log-entry warning">
            <strong>Unreachable States:</strong> ${results.unreachableStates.join(', ')}
          </div>`;
        }

        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('State registry check error:', error);
      }
    });

    // Texture Loading
    document.getElementById('checkTextureLoading').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('textureResults');
      resultsDiv.innerHTML = 'Checking texture loading...';

      try {
        const results = await testTextureLoading();

        // Format results
        let html = `<div class="success">Successfully loaded: ${results.success.length} textures</div>`;
        if (results.failed.length > 0) {
          html += `<div class="error">Failed to load: ${results.failed.join(', ')}</div>`;
        }

        html += '<div class="log-entry"><strong>Texture dimensions:</strong></div>';
        for (const [biome, dims] of Object.entries(results.dimensions)) {
          html += `<div class="log-entry">${biome}: ${dims.width}Ã—${dims.height}</div>`;
        }

        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('Texture loading error:', error);
      }
    });

    // Biome Distribution
    document.getElementById('analyzeBiomeDistribution').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('biomeResults');
      resultsDiv.innerHTML = 'Analyzing biome distribution...';

      try {
        const results = await analyzeMapGeneration();

        // Format results
        let html = `<div class="success">Analysis complete - ${results.totalHexes} hexes</div>`;

        html += '<div class="log-entry"><strong>Distribution:</strong></div>';
        for (const [biome, count] of Object.entries(results.biomeCounts)) {
          const percentage = ((count / results.totalHexes) * 100).toFixed(1);
          html += `<div class="log-entry">${biome}: ${count} (${percentage}%)</div>`;
        }

        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('Biome distribution analysis error:', error);
      }
    });

    // Helper function to display results
    function displayResults(container, results) {
      let html = '';

      results.tests.forEach(test => {
        const statusClass = test.passed ? 'success' : 'error';
        html += `<div class="log-entry ${statusClass}">
          <strong>${test.name}:</strong> ${test.passed ? 'PASS' : 'FAIL'}
          ${test.message ? `<br>${test.message}` : ''}
        </div>`;
      });

      container.innerHTML = html;
    }
  </script>
</body>
</html>