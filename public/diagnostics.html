<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beast Tactics - Diagnostics</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #222;
      color: #eee;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #4CAF50;
      margin-bottom: 20px;
    }
    .diagnostic-section {
      background: #333;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #3e8e41;
    }
    .results {
      padding: 10px;
      background: #2a2a2a;
      border-radius: 3px;
      font-family: monospace;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    .success {
      color: #4CAF50;
    }
    .warning {
      color: #FFA500;
    }
    .error {
      color: #F44336;
    }
    .log-entry {
      margin-bottom: 5px;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>Beast Tactics - System Diagnostics</h1>

  <div class="diagnostic-section">
    <h2>System Check</h2>
    <button id="runSystemCheck">Run System Check</button>
    <div id="systemCheckResults" class="results"></div>
  </div>

  <div class="diagnostic-section">
    <h2>State Registry</h2>
    <button id="checkStateRegistry">Check State Registry</button>
    <div id="stateRegistryResults" class="results"></div>
  </div>

  <div class="diagnostic-section">
    <h2>Texture Loading</h2>
    <button id="checkTextureLoading">Check Texture Loading</button>
    <div id="textureResults" class="results"></div>
  </div>

  <div class="diagnostic-section">
    <h2>Biome Distribution</h2>
    <button id="analyzeBiomeDistribution">Analyze Distribution</button>
    <div id="biomeResults" class="results"></div>
  </div>

  <script type="module">
    import { testTextureLoading } from '../tools/diagnostics/TextureLoader.js';
    import { analyzeMapGeneration } from '../tools/diagnostics/BiomeDistributionTest.js';
    import { runSystemCheck } from '../tools/diagnostics/SystemCheck.js';
    import { analyzeStateManager } from '../tools/diagnostics/StateRegistryCheck.js';

    // Helper to instantiate the game manager for diagnostics
    async function getTestGameManager() {
      try {
        // Dynamically import GameManager
        const { GameManager } = await import('../public/js/core/GameManager.js');

        // Create a fresh instance with testing flags
        const gameManager = new GameManager({
          version: '1.0.0',
          debugMode: true,
          testing: true
        });

        // Initialize the manager
        await gameManager.initialize();

        return gameManager;
      } catch (error) {
        console.error('Failed to create test game manager:', error);
        throw error;
      }
    }

    // System Check
    document.getElementById('runSystemCheck').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('systemCheckResults');
      resultsDiv.innerHTML = 'Running system check...';

      try {
        const results = await runSystemCheck();
        displayResults(resultsDiv, results);
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('System check error:', error);
      }
    });

    // State Registry Check
    document.getElementById('checkStateRegistry').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('stateRegistryResults');
      resultsDiv.innerHTML = 'Checking state registry...';

      try {
        const gameManager = await getTestGameManager();
        const stateManager = gameManager.stateManager;
        const results = analyzeStateManager(stateManager);

        // Format results
        let html = `<div class="${results.success ? 'success' : 'error'}">
          Status: ${results.success ? 'All states registered' : 'Issues detected'}
        </div>`;

        html += `<div class="log-entry">
          <strong>Registered States:</strong> ${results.validStateCount}/${results.totalStateCount}
        </div>`;

        if (results.missingStates.length > 0) {
          html += `<div class="log-entry error">
            <strong>Missing States:</strong> ${results.missingStates.join(', ')}
          </div>`;
        }

        if (results.transitionProblems.length > 0) {
          html += `<div class="log-entry error">
            <strong>Transition Problems:</strong>
          </div>`;

          results.transitionProblems.forEach(problem => {
            html += `<div class="log-entry error">- ${problem}</div>`;
          });
        }

        if (results.unreachableStates.length > 0) {
          html += `<div class="log-entry warning">
            <strong>Unreachable States:</strong> ${results.unreachableStates.join(', ')}
          </div>`;
        }

        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('State registry check error:', error);
      }
    });

    // Texture Loading
    document.getElementById('checkTextureLoading').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('textureResults');
      resultsDiv.innerHTML = 'Checking texture loading...';

      try {
        const results = await testTextureLoading();

        // Format results
        let html = `<div class="success">Successfully loaded: ${results.success.length} textures</div>`;
        if (results.failed.length > 0) {
          html += `<div class="error">Failed to load: ${results.failed.join(', ')}</div>`;
        }

        html += '<div class="log-entry"><strong>Texture dimensions:</strong></div>';
        for (const [biome, dims] of Object.entries(results.dimensions)) {
          html += `<div class="log-entry">${biome}: ${dims.width}Ã—${dims.height}</div>`;
        }

        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('Texture loading error:', error);
      }
    });

    // Biome Distribution
    document.getElementById('analyzeBiomeDistribution').addEventListener('click', async () => {
      const resultsDiv = document.getElementById('biomeResults');
      resultsDiv.innerHTML = 'Analyzing biome distribution...';

      try {
        const results = await analyzeMapGeneration();

        // Format results
        let html = `<div class="success">Analysis complete - ${results.totalHexes} hexes</div>`;

        html += '<div class="log-entry"><strong>Distribution:</strong></div>';
        for (const [biome, count] of Object.entries(results.biomeCounts)) {
          const percentage = ((count / results.totalHexes) * 100).toFixed(1);
          html += `<div class="log-entry">${biome}: ${count} (${percentage}%)</div>`;
        }

        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('Biome distribution analysis error:', error);
      }
    });

    // Helper function to display results
    function displayResults(container, results) {
      let html = '';

      results.tests.forEach(test => {
        const statusClass = test.passed ? 'success' : 'error';
        html += `<div class="log-entry ${statusClass}">
          <strong>${test.name}:</strong> ${test.passed ? 'PASS' : 'FAIL'}
          ${test.message ? `<br>${test.message}` : ''}
        </div>`;
      });

      container.innerHTML = html;
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Diagnostics</title>
  <style>
    body {
      background-color: #111;
      color: #0f0;
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 20px;
    }
    
    header {
      border-bottom: 2px solid #0f0;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    h1 {
      color: #0f0;
      text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
      margin: 0;
    }
    
    .subtitle {
      color: #0a0;
      font-size: 14px;
    }
    
    .main-content {
      display: flex;
      gap: 20px;
    }
    
    .control-panel {
      flex: 1;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #0a0;
    }
    
    .log-display {
      flex: 2;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 5px;
      height: 70vh;
      overflow-y: auto;
      border: 1px solid #0a0;
      font-size: 14px;
      word-break: break-word;
    }
    
    button {
      background: #222;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 8px 12px;
      margin: 5px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #333;
      box-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
    }
    
    .info-panel {
      margin-top: 20px;
      border-top: 1px dashed #0a0;
      padding-top: 10px;
    }
    
    .log-entry {
      margin-bottom: 3px;
      padding: 3px;
      border-radius: 2px;
    }
    
    .log-error {
      color: #f00;
      background: rgba(255, 0, 0, 0.1);
    }
    
    .log-warning {
      color: #ff0;
      background: rgba(255, 255, 0, 0.1);
    }
    
    .log-info {
      color: #0f0;
    }
    
    #status-display {
      font-size: 14px;
      margin-top: 10px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px dotted #0a0;
    }
    
    .status-label {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>Game Diagnostics</h1>
    <div class="subtitle">A debugging interface for game state and systems</div>
  </header>
  
  <div class="main-content">
    <div class="control-panel">
      <h2>Control Panel</h2>
      
      <div>
        <h3>Game State</h3>
        <div id="status-display">
          <div class="status-item">
            <span class="status-label">Current State:</span>
            <span id="current-state">Loading...</span>
          </div>
          <div class="status-item">
            <span class="status-label">Turn:</span>
            <span id="current-turn">0</span>
          </div>
          <div class="status-item">
            <span class="status-label">Active Player:</span>
            <span id="active-player">None</span>
          </div>
        </div>
      </div>
      
      <div class="button-group">
        <h3>Diagnostics</h3>
        <button id="run-all-diagnostics">Run All Diagnostics</button>
        <button id="fix-state-issues">Fix State Issues</button>
        <button id="validate-player-input">Validate Player Input</button>
      </div>
      
      <div class="button-group">
        <h3>Game Control</h3>
        <button id="toggle-debug-mode">Toggle Debug Mode</button>
        <button id="reset-game">Reset Game</button>
        <button id="dump-state">Dump Game State</button>
      </div>
      
      <div class="info-panel">
        <h3>Diagnostic Info</h3>
        <div id="diagnostic-info">
          No diagnostics run yet.
        </div>
      </div>
    </div>
    
    <div class="log-display" id="log-container">
      <div class="log-entry log-info">[System] Diagnostic interface loading...</div>
    </div>
  </div>
  
  <script type="module">
    import { createDiagnosticsUI } from '../tools/diagnostics/DiagnosticsUI.js';
    import { diagnoseStateTransitions, fixCommonStateIssues } from '../tools/diagnostics/StateTransitionDebugger.js';
    import { validatePlayerInputState } from '../tools/diagnostics/StateDebugger.js';
    import { GameManager } from '../public/js/core/GameManager.js';
    import { Logger } from '../public/js/utils/Logger.js';
    
    // Set up logging to UI
    const logContainer = document.getElementById('log-container');
    
    function logToUI(message, type = 'info') {
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      
      const timestamp = new Date().toISOString().substr(11, 8);
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // Override console methods to also log to UI
    const originalConsoleLog = console.log;
    const originalConsoleWarn = console.warn;
    const originalConsoleError = console.error;
    
    console.log = function(...args) {
      originalConsoleLog.apply(console, args);
      logToUI(args.join(' '), 'info');
    };
    
    console.warn = function(...args) {
      originalConsoleWarn.apply(console, args);
      logToUI(args.join(' '), 'warning');
    };
    
    console.error = function(...args) {
      originalConsoleError.apply(console, args);
      logToUI(args.join(' '), 'error');
    };
    
    // Initialize game manager
    let gameManager = null;
    let diagnosticsUI = null;
    
    async function initializeDiagnostics() {
      logToUI('Initializing game manager for diagnostics...');
      
      try {
        // Initialize game manager
        gameManager = new GameManager({
          debugMode: true,
          diagnosticsMode: true
        });
        
        await gameManager.initialize();
        
        logToUI('Game manager initialized successfully.');
        
        // Create diagnostics UI
        diagnosticsUI = createDiagnosticsUI(gameManager);
        diagnosticsUI.initialize();
        
        // Set up UI update interval
        setInterval(updateUI, 1000);
        
        // Set up button handlers
        document.getElementById('run-all-diagnostics').addEventListener('click', runAllDiagnostics);
        document.getElementById('fix-state-issues').addEventListener('click', fixStateIssues);
        document.getElementById('validate-player-input').addEventListener('click', validatePlayerInput);
        document.getElementById('toggle-debug-mode').addEventListener('click', toggleDebugMode);
        document.getElementById('reset-game').addEventListener('click', resetGame);
        document.getElementById('dump-state').addEventListener('click', dumpGameState);
        
        logToUI('Diagnostic interface ready.');
      } catch (error) {
        logToUI(`Error initializing diagnostics: ${error.message}`, 'error');
        console.error('Initialization error:', error);
      }
    }
    
    function updateUI() {
      if (!gameManager || !gameManager.stateManager) return;
      
      // Update state display
      document.getElementById('current-state').textContent = gameManager.stateManager.currentState || 'None';
      document.getElementById('current-turn').textContent = gameManager.currentTurn || 0;
      
      // Update active player
      const activePlayer = gameManager.playerManager?.activePlayer;
      document.getElementById('active-player').textContent = activePlayer ? activePlayer.name : 'None';
    }
    
    function runAllDiagnostics() {
      logToUI('Running all diagnostics...');
      
      try {
        if (!gameManager || !gameManager.stateManager) {
          logToUI('Game manager or state manager not available!', 'error');
          return;
        }
        
        // Run state transition diagnostics
        const stateResults = diagnoseStateTransitions(gameManager.stateManager, gameManager);
        
        // Run PlayerInputState validation
        const playerInputResults = validatePlayerInputState(gameManager.stateManager);
        
        // Update diagnostic info panel
        const diagInfo = document.getElementById('diagnostic-info');
        
        diagInfo.innerHTML = `
          <p><b>State System:</b> ${stateResults.issues.length} issues found</p>
          <p><b>PlayerInputState:</b> ${playerInputResults.issues.length} issues found</p>
          <p><b>Available States:</b> ${stateResults.availableStates.join(', ')}</p>
        `;
        
        if (stateResults.issues.length > 0) {
          logToUI(`State system has ${stateResults.issues.length} issues:`, 'warning');
          stateResults.issues.forEach(issue => {
            logToUI(`- ${issue}`, 'warning');
          });
        } else {
          logToUI('State system looks good!');
        }
        
        if (playerInputResults.issues.length > 0) {
          logToUI(`PlayerInputState has ${playerInputResults.issues.length} issues:`, 'warning');
          playerInputResults.issues.forEach(issue => {
            logToUI(`- ${issue}`, 'warning');
          });
        } else {
          logToUI('PlayerInputState looks good!');
        }
        
        logToUI('All diagnostics complete.');
      } catch (error) {
        logToUI(`Error running diagnostics: ${error.message}`, 'error');
        console.error('Diagnostics error:', error);
      }
    }
    
    function fixStateIssues() {
      logToUI('Attempting to fix state issues...');
      
      try {
        if (!gameManager || !gameManager.stateManager) {
          logToUI('Game manager or state manager not available!', 'error');
          return;
        }
        
        const results = fixCommonStateIssues(gameManager.stateManager, gameManager);
        
        logToUI(`Fix attempts complete. ${results.fixesSucceeded.length} succeeded, ${results.remainingIssues.length} issues remain.`);
        
        results.fixesSucceeded.forEach(fix => {
          logToUI(`- Fixed: ${fix}`);
        });
        
        results.remainingIssues.forEach(issue => {
          logToUI(`- Remaining issue: ${issue}`, 'warning');
        });
      } catch (error) {
        logToUI(`Error fixing issues: ${error.message}`, 'error');
        console.error('Fix error:', error);
      }
    }
    
    function validatePlayerInput() {
      logToUI('Validating PlayerInputState...');
      
      try {
        if (!gameManager || !gameManager.stateManager) {
          logToUI('Game manager or state manager not available!', 'error');
          return;
        }
        
        const results = validatePlayerInputState(gameManager.stateManager);
        
        logToUI(`Validation complete. Found ${results.issues.length} issues.`);
        
        const diagInfo = document.getElementById('diagnostic-info');
        
        diagInfo.innerHTML = `
          <p><b>PlayerInputState exists:</b> ${results.stateExists ? 'Yes' : 'No'}</p>
          <p><b>Has incoming transitions:</b> ${results.inTransitions ? 'Yes' : 'No'}</p>
          <p><b>Transition sources:</b> ${results.transitionSources.join(', ') || 'None'}</p>
          <p><b>Transition targets:</b> ${results.transitionTargets.join(', ') || 'None'}</p>
          <p><b>Issues found:</b> ${results.issues.length}</p>
        `;
        
        if (results.issues.length > 0) {
          results.issues.forEach(issue => {
            logToUI(`- ${issue}`, 'warning');
          });
        }
      } catch (error) {
        logToUI(`Error validating PlayerInputState: ${error.message}`, 'error');
        console.error('Validation error:', error);
      }
    }
    
    function toggleDebugMode() {
      try {
        gameManager.debugMode = !gameManager.debugMode;
        logToUI(`Debug mode ${gameManager.debugMode ? 'enabled' : 'disabled'}.`);
      } catch (error) {
        logToUI(`Error toggling debug mode: ${error.message}`, 'error');
      }
    }
    
    function resetGame() {
      logToUI('Resetting game...');
      
      try {
        // First transition to GAME_SETUP
        if (gameManager.stateManager) {
          try {
            gameManager.stateManager.changeState('GAME_SETUP');
          } catch (e) {
            logToUI(`Could not transition to GAME_SETUP: ${e.message}`, 'warning');
          }
        }
        
        // Reset turns
        gameManager.currentTurn = 0;
        
        // Reset players
        if (gameManager.playerManager) {
          const players = gameManager.playerManager.getPlayers();
          players.forEach(player => {
            player.hasProvidedInput = false;
            player.currentInput = null;
          });
        }
        
        logToUI('Game reset complete.');
      } catch (error) {
        logToUI(`Error resetting game: ${error.message}`, 'error');
        console.error('Error resetting game:', error);
      }
    }
    
    function dumpGameState() {
      logToUI('Dumping current game state...');
      
      try {
        const stateDump = {
          currentState: gameManager.stateManager?.currentState,
          previousState: gameManager.stateManager?.previousState,
          currentTurn: gameManager.currentTurn,
          playerCount: gameManager.playerManager?.getPlayers().length || 0,
          debugMode: gameManager.debugMode,
          validTransitions: gameManager.stateManager?._validTransitions
        };
        
        console.log('Game state dump:', stateDump);
        logToUI('Game state dumped to console.');
        
        // Also show in diagnostic panel
        const diagInfo = document.getElementById('diagnostic-info');
        diagInfo.innerHTML = `<pre>${JSON.stringify(stateDump, null, 2)}</pre>`;
      } catch (error) {
        logToUI(`Error dumping game state: ${error.message}`, 'error');
      }
    }
    
    // Initialize on page load
    window.addEventListener('load', initializeDiagnostics);
  </script>
</body>
</html>
